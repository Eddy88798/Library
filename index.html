<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Golden Scrolls ‚Äî Reader</title>
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700;800&family=Montserrat:wght@700&family=EB+Garamond:wght@700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <style>
    /* üèõ Luxury Theme Style System */
    :root {
      --gold-start: #FFD700;
      --gold-end: #FFB700;
      --charcoal: #0d0d0d;
      --charcoal-light: #1c1c1c;
      --ivory: #fdfcf7;
      --font-title: 'Playfair Display', serif;
      --font-body: 'Inter', sans-serif;
      --font-glow: 'Montserrat', 'Inter', sans-serif;
      --font-quote: 'Dancing Script', cursive;
    }

    html, body { height: 100%; }

    body {
      font-family: var(--font-body);
      min-height: 100vh;
      background: var(--charcoal);
      color: var(--ivory);
      letter-spacing: 0.01em;
      line-height: 1.7;
      font-size: 1.08rem;
    }

    /* Typography & General Styles */
    .brand-title, .writer-quote, .book-title, #authTitle {
      font-family: var(--font-title);
      letter-spacing: 0.03em;
    }
    .brand-title {
      background: linear-gradient(45deg, var(--gold-start), var(--gold-end));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 16px rgba(255, 215, 0, 0.2);
      font-weight: 800;
      letter-spacing: 0.09em;
    }

    h1, h2, h3, h4, .book-title, #authTitle {
      font-family: 'EB Garamond', var(--font-title), serif;
      letter-spacing: 0.04em;
      font-weight: 700;
      color: var(--gold-start);
    }

    /* Loader */
    #loaderOverlay {
      position: fixed; inset: 0; z-index: 9999;
      background: var(--charcoal);
      display: flex; align-items: center; justify-content: center;
      transition: opacity 0.65s ease-in-out;
    }
    #loaderOverlay.hide { opacity: 0; }
    .loader-text {
      font-family: var(--font-title);
      font-size: 1.5rem; color: var(--gold-start); text-align: center;
      margin-top: 1rem; text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    }
    .loader-book svg { width: 92px; height: 92px; }

    /* Header */
    header {
      background: rgba(13, 13, 13, 0.6);
      border-bottom: 1px solid rgba(255, 215, 0, 0.2);
      font-family: var(--font-glow);
    }

    /* üåü Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      font-family: var(--font-glow);
      font-weight: 700;
      border-radius: 10px;
      padding: 0.75rem 1.7rem;
      cursor: pointer;
      font-size: 1.12rem;
      letter-spacing: 0.04em;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.08), 0 1.5px 8px 0 rgba(0,0,0,0.10);
      text-shadow: 0 1px 5px rgba(255,215,0,0.08), 0 2px 8px rgba(0,0,0,0.15);
      transition:
        transform 0.22s cubic-bezier(.29,1.01,.49,1.02),
        box-shadow 0.22s cubic-bezier(.29,1.01,.49,1.02),
        background 0.28s cubic-bezier(.29,1.01,.49,1.02),
        color 0.18s;
      position: relative;
      overflow: hidden;
    }

    /* ‚ú® Glowing Gold Button */
    .btn-gold, .book-btn {
      background: linear-gradient(90deg, var(--gold-start), var(--gold-end), #fffbe7 88%);
      color: #111;
      border: none;
      box-shadow:
        0 0 15px 3px rgba(255, 215, 0, 0.55),
        0 0 40px 4px rgba(255, 215, 0, 0.16),
        0 2px 12px rgba(255, 215, 0, 0.13);
      font-family: var(--font-glow);
      font-weight: 800;
      letter-spacing: 0.06em;
      text-shadow: 0 3px 20px rgba(255,215,0,0.19), 0 1px 2px rgba(255,255,255,0.12);
      outline: none;
      border-radius: 12px;
      animation: goldGlow 2.5s infinite alternate;
    }
    @keyframes goldGlow {
      0% {
        box-shadow:
          0 0 18px 3px rgba(255, 215, 0, 0.32),
          0 0 40px 4px rgba(255, 215, 0, 0.12),
          0 2px 12px rgba(255, 215, 0, 0.13);
        filter: brightness(1.08);
      }
      100% {
        box-shadow:
          0 0 38px 7px rgba(255, 215, 0, 0.74),
          0 0 70px 10px rgba(255, 225, 100, 0.15);
        filter: brightness(1.14) drop-shadow(0 0 12px #FFD700);
      }
    }
    .btn-gold:hover,
    .book-btn:hover {
      transform: translateY(-3px) scale(1.045) rotate(-1deg);
      background: linear-gradient(90deg, #fffbe7 8%, var(--gold-start) 60%, var(--gold-end) 100%);
      color: #222;
      box-shadow:
        0 0 35px 11px rgba(255, 215, 0, 0.85),
        0 0 60px 14px rgba(255, 225, 100, 0.19),
        0 3px 20px rgba(255, 215, 0, 0.30);
      text-shadow: 0 0 16px #fffbe7, 0 2px 8px #FFD700;
      outline: 2px solid #fffbe7;
      outline-offset: -3px;
      z-index: 2;
    }
    .btn-ghost {
      background: transparent;
      border: 1.5px solid rgba(255, 215, 0, 0.6);
      color: var(--ivory);
      font-weight: 700;
      font-family: var(--font-glow);
      transition: background 0.2s, color 0.2s, border 0.2s;
      box-shadow: 0 3px 16px 0px rgba(255, 215, 0, 0.09);
    }
    .btn-ghost:hover {
      background: rgba(255, 215, 0, 0.19);
      color: var(--gold-start);
      border-color: var(--gold-start);
      box-shadow: 0 0 15px 2px rgba(255, 215, 0, 0.22);
    }

    /* Tag */
    .tag {
      font-size: 0.8rem;
      background: rgba(255, 215, 0, 0.1);
      color: var(--gold-start);
      font-weight: 700;
      border-radius: 2em;
      padding: 0.2em 0.8em;
      border: 1px solid rgba(255, 215, 0, 0.3);
      text-shadow: none;
      font-family: var(--font-glow);
      letter-spacing: 0.06em;
    }

    /* üíé Modals (Login, PayPal, Writer Section) */
    .modal-container {
      background: linear-gradient(180deg, #111, var(--charcoal-light));
      border: 1px solid rgba(255, 215, 0, 0.5);
      border-radius: 14px;
      padding: 2.2rem;
      box-shadow: 0 0 40px rgba(255, 215, 0, 0.33);
      color: var(--ivory);
      font-family: var(--font-body);
    }
    #authSection .modal-container, #payModal .modal-container {
      max-width: 530px;
      width: 97vw;
    }
    .meet-writer-section { /* Applying modal style to this section */
      max-width: 560px; margin: 2.5rem auto 3rem auto;
      background: linear-gradient(180deg, #111, var(--charcoal-light));
      border: 1.5px solid rgba(255, 215, 0, 0.5);
      border-radius: 14px; padding: 2.1rem;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.19);
      display: flex; flex-direction: column; align-items: center;
    }
    .writer-img {
      width: 108px; height: 108px; border-radius: 50%;
      object-fit: cover; border: 4px solid var(--gold-start);
      box-shadow: 0 2px 18px rgba(0,0,0,0.5); margin-bottom: 1.3rem;
    }
    .writer-quote {
      color: var(--gold-start); font-size: 1.5rem; font-weight: 700;
      text-align: center; line-height: 1.45; margin-bottom: 0.6rem;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
      letter-spacing: 0.05em;
    }
    .quote-content {
      font-family: var(--font-quote);
      font-weight: 700;
      font-size: 2.2rem;
      text-align: center;
      line-height: 1.45;
      color: var(--gold-start);
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
      letter-spacing: 0.05em;
    }
    .writing-emoji {
      font-size: 3rem;
      margin-left: 1.5rem;
      /* The original animation, now replaced below */
      /* animation: write-animation 1.5s ease-in-out infinite alternate; */
      animation: writing-dance 1.1s infinite;
      display: inline-block;
      transform-origin: 60% 80%; /* Make it pivot from the tip of the pen */
    }
    .writer-meta { color: var(--ivory); opacity: 0.8; font-style: italic; }
    @keyframes write-animation {
      from { transform: rotate(5deg) translateX(0); }
      to { transform: rotate(-5deg) translateX(5px); }
    }
    @keyframes writing-dance {
      0% {
        transform: rotate(-12deg) translateY(0px) scale(1.08);
      }
      15% {
        transform: rotate(9deg) translateY(-5px) scale(1.12);
      }
      30% {
        transform: rotate(-7deg) translateY(3px) scale(1.05);
      }
      45% {
        transform: rotate(7deg) translateY(-4px) scale(1.12);
      }
      60% {
        transform: rotate(-6deg) translateY(2px) scale(1.09);
      }
      75% {
        transform: rotate(5deg) translateY(-2px) scale(1.13);
      }
      100% {
        transform: rotate(-12deg) translateY(0px) scale(1.08);
      }
    }

    /* GS Logo Animation */
    .gs-logo-rotate {
      animation: gs-spin 2.6s linear infinite;
      will-change: transform;
      display: grid;
      place-items: center;
    }
    @keyframes gs-spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Form Inputs */
    input, select, textarea {
      width: 100%; rounded: 8px; padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1.5px solid rgba(255, 215, 0, 0.3);
      color: var(--ivory);
      border-radius: 8px;
      font-family: var(--font-glow);
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 0.03em;
      margin-bottom: 0.1rem;
      outline: none;
      box-shadow: 0 0 0 0 rgba(255,215,0,0.04);
      transition: box-shadow 0.18s, border-color 0.18s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 16px 2px rgba(255, 215, 0, 0.13);
      border-color: var(--gold-start);
      background: rgba(255, 255, 255, 0.15);
    }

    /* üìö Book Cards */
    #booksGrid, #comingSoonGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 3rem 2.5rem;
      margin-top: 2rem;
    }
    .book-card {
      background: linear-gradient(145deg, var(--charcoal-light), #0a0a0a);
      border: 1.5px solid rgba(255, 215, 0, 0.48);
      border-radius: 16px;
      overflow: hidden;
      transition: transform 0.3s cubic-bezier(.29,1.01,.49,1.02), box-shadow 0.3s;
      box-shadow: 0 0 18px rgba(255, 215, 0, 0.13);
      display: flex; flex-direction: column;
      text-align: center;
    }
    .book-card:hover {
      transform: translateY(-8px) scale(1.048);
      box-shadow: 0 0 44px rgba(255, 215, 0, 0.41);
      border-color: var(--gold-start);
    }
    .book-img {
      width: 100%;
      object-position: top;
      border-bottom: 1.5px solid rgba(255, 215, 0, 0.4);
      margin-bottom: 1.25rem;
    }
    .book-meta {
      padding: 1.5rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .book-title {
      font-size: 2rem;
      line-height: 1.15;
      color: var(--gold-start);
      margin-bottom: 0.25rem;
      font-family: 'EB Garamond', var(--font-title), serif;
      font-weight: 800;
      text-shadow: 0 2px 14px #fffbe7, 0 1px 4px #FFD700;
      letter-spacing: 0.07em;
    }
    .book-author {
      font-size: 1.05rem; color: var(--ivory); opacity: 0.82;
      margin-bottom: 0.8rem; font-weight: 600;
      font-family: var(--font-glow);
    }
    .book-desc {
      color: var(--ivory); opacity: .91;
      font-size: 1.02rem; line-height: 1.54;
      flex-grow: 1; margin-bottom: 1.5rem;
      font-family: var(--font-body);
      display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;
    }
    .book-bottom-row {
      display: flex; gap: 1rem; align-items: center; justify-content: center; flex-wrap: wrap;
    }
    .book-btn { /* Alias for btn-gold, see above for glow, font, etc. */
      background: linear-gradient(45deg, var(--gold-start), var(--gold-end));
      color: #111; font-weight: 900; border-radius: 12px;
      padding: 0.8rem 1.7rem; cursor: pointer;
      letter-spacing: 0.08em;
      font-family: var(--font-glow);
      font-size: 1.08rem;
      box-shadow: 0 0 22px 5px rgba(255, 215, 0, 0.55), 0 0 38px 9px rgba(255, 215, 0, 0.13);
      transition: transform 0.22s, box-shadow 0.22s, background 0.18s, color 0.18s;
      outline: none;
      animation: goldGlow 2.7s infinite alternate;
    }
    .book-btn:hover {
      background: linear-gradient(90deg, #fffbe7 5%, var(--gold-start) 50%, var(--gold-end) 100%);
      color: #111;
      box-shadow: 0 0 42px 12px #FFD700, 0 0 60px 24px rgba(255, 225, 100, 0.18), 0 3px 20px rgba(255, 215, 0, 0.38);
      transform: translateY(-3px) scale(1.055) rotate(-2deg);
      text-shadow: 0 0 18px #fffbe7, 0 2px 8px #FFD700;
      outline: 2px solid #fffbe7;
      outline-offset: -3px;
      z-index: 2;
    }
    .book-btn.secondary { /* Ghost style for secondary book buttons */
      background: transparent;
      border: 1.5px solid rgba(255, 215, 0, 0.5);
      color: var(--ivory);
      box-shadow: none;
      font-weight: 700;
      font-family: var(--font-glow);
      transition: background 0.21s, color 0.21s, border 0.21s, box-shadow 0.21s;
    }
    .book-btn.secondary:hover {
      background: rgba(255, 215, 0, 0.11);
      color: var(--gold-start);
      border-color: var(--gold-start);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.21);
    }
    .book-btn.coming-soon {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.5);
      border: 1.5px solid rgba(255, 255, 255, 0.2);
      box-shadow: none;
      cursor: not-allowed;
      animation: none;
      pointer-events: none;
      transform: none;
    }
    .book-price {
      font-size: 1.06rem; color: var(--gold-start); font-weight: 800;
      background: rgba(255, 215, 0, 0.12); border-radius: 2em;
      padding: 0.33em 1.09em; border: 1.5px solid rgba(255, 215, 0, 0.33);
      letter-spacing: 0.03em;
      font-family: var(--font-glow);
      box-shadow: 0 1px 8px rgba(255,215,0,0.09);
    }

    /* üìñ Reader */
    #readerOverlay .reader-panel {
      background: var(--charcoal);
      border-left: 1.5px solid rgba(255, 215, 0, 0.5);
    }
    #pdfViewerContainer {
      width: 100%; height: 100%; overflow-y: auto;
      background: #fbf5e9; /* Aged parchment for immersion */
      display: flex; flex-direction: column; align-items: center;
      padding: 1rem;
    }
    #pdfCanvas {
      max-width: 98vw; width: 100%; height: auto;
      border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.2);
    }
    #pdfControls {
      display: flex; justify-content: center; align-items: center;
      gap: 1rem; padding: 0.75rem;
      background: rgba(13,13,13,0.8); backdrop-filter: blur(10px);
      border: 1.5px solid rgba(255, 215, 0, 0.3);
      border-radius: 10px; margin-bottom: 1rem;
      position: sticky; top: 1rem; z-index: 10;
    }
    #pdfControls button {
      min-width: 44px; min-height: 36px;
      font-size: 1.22rem;
    }
    #pdfPageInfo {
      font-size: 1.05rem; font-weight: 700; color: var(--ivory);
      padding: 4px 12px; border-radius: 7px;
      font-family: var(--font-glow);
    }

    /* Scrollbar */
    .scrollbar::-webkit-scrollbar { width: 10px; height: 10px; }
    .scrollbar::-webkit-scrollbar-thumb { background: rgba(255,215,0,.4); border-radius: 999px; }
  </style>
  <script src="https://www.paypal.com/sdk/js?client-id=AawlYSj0dUanqnCXWOcFyy_SuqPGQ1MqWL738Xn_t39gRSLC-mJj_IrTC6MQ29Db5A5JRh0DVHPB-r19&components=buttons&currency=USD"></script>
</head>
<body class="scrollbar">
  <div id="loaderOverlay">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
      <span class="loader-book">
        <svg viewBox="0 0 92 92" fill="none">
          <defs>
            <linearGradient id="goldShine" x1="0" y1="0" x2="92" y2="92" gradientUnits="userSpaceOnUse">
              <stop stop-color="#FFD700" />
              <stop offset="1" stop-color="#fffbe7" />
            </linearGradient>
          </defs>
          <path d="M46 14 Q24 14 16 28 Q14 34 14 51 Q14 68 46 78" stroke="url(#goldShine)" stroke-width="4" fill="none"/>
          <path d="M46 14 Q68 14 76 28 Q78 34 78 51 Q78 68 46 78" stroke="url(#goldShine)" stroke-width="4" fill="none"/>
        </svg>
      </span>
      <span class="loader-text">Golden Scrolls<br>Loading...</span>
    </div>
  </div>

  <header class="sticky top-0 z-30 backdrop-blur-lg">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-yellow-500 to-yellow-300 gs-logo-rotate text-black font-extrabold">GS</div>
      <div class="flex-1">
        <h1 class="brand-title text-2xl sm:text-3xl">Golden Scrolls</h1>
        <p class="text-xs opacity-80 -mt-1" style="color:#fdfcf7">Read beautifully</p>
      </div>
      <div id="userBadge" class="hidden md:flex items-center gap-3">
        <span id="userEmail" class="tag">guest</span>
        <button id="logoutBtn" class="btn btn-ghost">Logout</button>
      </div>
    </div>
  </header>

  <section class="meet-writer-section">
    <img src="https://pub-954ee37e70244de5bb62c446533dbea3.r2.dev/file_000000006cb462468d922fde071e3fe9 (1).png" alt="Writer" class="writer-img" />
    <div class="flex items-center">
      <div class="quote-content">‚ÄúI write not for fame but for the echo in a reader's soul.‚Äù <span class="writing-emoji">‚úçÔ∏è</span></div>
    </div>
    <div class="writer-meta">- Mfuneni Barnabas Mabunda</div>
  </section>

  <section id="authSection" class="fixed inset-0 z-50 grid place-items-center bg-black bg-opacity-60 transition duration-300 hidden">
    <div class="modal-container relative">
      <button id="closeAuthModalBtn" class="absolute top-3 right-3 btn btn-ghost px-2 py-1 text-xs">X</button>
      <div class="flex items-center gap-2 mb-4">
        <span class="tag">Secure Access</span>
      </div>
      <h2 id="authTitle" class="text-3xl font-extrabold mb-2" style="color: var(--gold-start);">Welcome back</h2>
      <p id="authDesc" class="opacity-80 mb-6">Sign in with your email and password.</p>
      <form id="loginForm" class="grid gap-4">
        <div>
          <label class="block text-sm mb-1 opacity-80">Email</label>
          <input required type="email" id="emailInput" placeholder="you@example.com" />
        </div>
        <div>
          <label class="block text-sm mb-1 opacity-80">Name</label>
          <input required type="text" id="nameInput" placeholder="Coolcat" />
        </div>
        <div>
          <label class="block text-sm mb-1 opacity-80">Password</label>
          <input required type="password" id="passwordInput" placeholder="Password" />
        </div>
        <div id="confirmPasswordDiv" style="display:none;">
          <label class="block text-sm mb-1 opacity-80">Confirm Password</label>
          <input required type="password" id="confirmPasswordInput" placeholder="Repeat password" />
        </div>
        <div class="flex items-center justify-between mt-2">
          <button class="btn btn-gold" type="submit"><span id="authBtnText">Continue</span></button>
          <a href="#" id="toggleAuthMode" class="text-sm text-yellow-400 underline ml-2"></a>
        </div>
        <div>
          <a href="#" id="forgotPasswordLink" class="text-xs text-yellow-300 underline">Forgot Password?</a>
        </div>
      </form>
      <p id="authMsg" class="mt-4 text-sm opacity-80"></p>
    </div>
  </section>

  <main id="catalogSection" class="max-w-6xl mx-auto px-4 py-10">
    <div class="flex flex-wrap items-end justify-between gap-4 mb-6">
      <div>
        <h3 class="text-2xl sm:text-3xl font-extrabold brand-title">Your Library</h3>
        <p class="opacity-70">Discover and read your purchased books.</p>
      </div>
    </div>
    <div id="booksGrid"></div>

    <div id="comingSoonSection" class="mt-16">
      <div class="flex flex-wrap items-end justify-between gap-4 mb-6">
        <div>
          <h3 class="text-2xl sm:text-3xl font-extrabold brand-title">Coming Soon</h3>
          <p class="opacity-70">Be the first to know when these books are released.</p>
        </div>
      </div>
      <div id="comingSoonGrid"></div>
    </div>
  </main>

  <section id="readerOverlay" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"></div>
    <div class="reader-panel absolute inset-y-0 right-0 w-full md:w-[900px] shadow-2xl flex flex-col">
      <div class="p-4 flex items-center gap-3 border-b border-white border-opacity-10">
        <button id="closeReaderBtn" class="btn btn-ghost">Close</button>
        <div class="flex-1 text-center font-bold text-lg" id="readerTitle" style="color: var(--gold-start);"></div>
      </div>
      <div class="flex-1 overflow-hidden relative">
        <div id="pdfViewerContainer" class="hidden">
          <canvas id="pdfCanvas"></canvas>
        </div>
         <div id="pdfControls" class="absolute top-0 left-1/2 -translate-x-1/2 mt-4">
            <button id="pdfPrevPage" title="Previous Page" class="btn btn-gold">&lt;</button>
            <span id="pdfPageInfo">Page 1 / 1</span>
            <button id="pdfNextPage" title="Next Page" class="btn btn-gold">&gt;</button>
          </div>
        <iframe id="readerFrame" class="w-full h-full" title="Book Reader" sandbox="allow-scripts allow-forms"></iframe>
      </div>
    </div>
  </section>

  <section id="payModal" class="hidden fixed inset-0 z-50 grid place-items-center bg-black bg-opacity-60">
    <div class="modal-container">
      <h4 class="text-2xl mb-1 font-title" style="color:var(--gold-start);">Purchase Book</h4>
      <p id="payModalDesc" class="opacity-80 mb-4">Complete your purchase to unlock this book.</p>
      <div id="paypalButtons" class="mb-3"></div>
      <button id="cancelPayBtn" class="btn btn-ghost w-full">Cancel</button>
    </div>
  </section>

  <footer class="py-10 text-center opacity-70 text-sm" style="color:var(--ivory)">¬© <span id="year"></span> Golden Scrolls</footer>

  <script>
    // Loader logic: Hide loader after main content is ready
    function hideLoader() {
      const loader = document.getElementById("loaderOverlay");
      if (loader) loader.classList.add("hide");
      setTimeout(()=>{ if(loader) loader.style.display="none"; }, 650);
    }

    const APP_ID = "5E90AA5A-556F-4BF5-BC9D-DC2EC1313DC6";
    const API_KEY = "B37B6BE6-BE07-412B-8E16-6C7926DA1B25";

    const state = {
      user: null, deviceId: null, books: [], selectedBook: null,
      deferredAction: null,
      pdf: { url: null, doc: null, currentPage: 1, totalPages: 1, rendering: false, bookId: null }
    };

    function el(id){ return document.getElementById(id); }

    function uuid(){
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    function getDeviceId(){
      let d = localStorage.getItem("gs_device_id");
      if(!d){ d = `GS-${uuid()}`; localStorage.setItem("gs_device_id", d); }
      return d;
    }

    async function initBackendless(){
      Backendless.serverURL = "https://api.backendless.com";
      Backendless.initApp(APP_ID, API_KEY);
    }

    function setAuthUI(loggedIn){
      el('userBadge').classList.toggle('hidden', !loggedIn);
    }

    function info(msg){ el('authMsg').textContent = msg || ''; }

    function isPaidFor(bookId){
      try{
        const paid = JSON.parse(state.user?.paidbooks || '[]');
        return paid.includes(bookId);
      }catch{ return false; }
    }

    function renderBooks(items){
      // Filter out 'The Fountain of Life' from the main list
      const releasedBooks = items.filter(b => b.title !== "The Fountain of Life");
      const comingSoonBook = items.find(b => b.title === "The Fountain of Life");
      
      const grid = el('booksGrid');
      grid.innerHTML = '';
      releasedBooks.forEach(b => {
        const paid = isPaidFor(b.objectId);
        const card = document.createElement('article');
        card.className = "book-card";
        card.innerHTML = `
          <img src="${b.cover || 'https://picsum.photos/seed/book/640/900'}" alt="Cover for ${b.title}" class="book-img"/>
          <div class="book-meta">
            <div class="book-title">${b.title || ''}</div>
            <div class="book-author">${b.author || ''}</div>
            <div class="book-desc">${b.description || 'No description provided.'}</div>
            <div class="book-bottom-row">
              ${paid
                ? `<button data-id="${b.objectId}" class="book-btn readBtn">Read</button>
                   <button data-id="${b.objectId}" class="book-btn secondary openLinkBtn">Link</button>`
                : `<button data-id="${b.objectId}" class="book-btn readBtn">Buy to Read ($${(Number(b.price)||0).toFixed(2)})</button>`
              }
            </div>
          </div>`;
        grid.appendChild(card);
      });

      const comingSoonGrid = el('comingSoonGrid');
      comingSoonGrid.innerHTML = '';
      if (comingSoonBook) {
        const card = document.createElement('article');
        card.className = "book-card";
        card.innerHTML = `
          <img src="${comingSoonBook.cover || 'https://picsum.photos/seed/book/640/900'}" alt="Cover for ${comingSoonBook.title}" class="book-img"/>
          <div class="book-meta">
            <div class="book-title">${comingSoonBook.title || ''}</div>
            <div class="book-author">${comingSoonBook.author || ''}</div>
            <div class="book-desc">${comingSoonBook.description || 'No description provided.'}</div>
            <div class="book-bottom-row">
              <button class="book-btn coming-soon">Coming Soon</button>
            </div>
          </div>`;
        comingSoonGrid.appendChild(card);
      }

      grid.querySelectorAll('.readBtn').forEach(btn => btn.addEventListener('click', (e) => requireLoginThen(() => onReadClick(e))));
      grid.querySelectorAll('.openLinkBtn').forEach(btn => btn.addEventListener('click', e => {
        e.preventDefault();
        const id = e.currentTarget.getAttribute('data-id');
        const book = state.books.find(x=>x.objectId===id);
        if(book?.links) window.open(book.links, '_blank');
      }));
    }

    function requireLoginThen(action){
      if(!state.user){
        state.deferredAction = action;
        showAuthModal('login');
      }else{
        action();
      }
    }

    async function onReadClick(e){
      const id = e.currentTarget.getAttribute('data-id');
      const book = state.books.find(b => b.objectId === id);
      if (!book) return;

      if (isPaidFor(id)) {
        // Paid ‚Üí Open the full reader
        openReader(book, false);
      } else {
        // Not paid ‚Üí Skip preview, go straight to purchase
        if (confirm(`To read "${book.title}", you need to purchase it. Proceed to checkout?`)) {
          state.selectedBook = book;
          onBuyClick({ currentTarget: { getAttribute: () => book.objectId } });
        }
      }
    }

    function isPDF(url) { return /\.pdf(\?|$)/i.test(url); }

    function openReader(book, preview){
      state.selectedBook = book;
      el('readerTitle').textContent = preview ? `Preview ‚Äî ${book.title||''}` : `${book.title||''}`;
      const url = preview ? (book.previewUrl || book.bookUrl) : book.bookUrl;

      el('readerFrame').classList.add('hidden');
      el('pdfViewerContainer').classList.add('hidden');

      if(isPDF(url)){
        openPDFViewer(url, book.objectId);
      } else {
        const frame = el('readerFrame');
        frame.src = url || book.links || 'about:blank';
        frame.classList.remove('hidden');
      }
      el('readerOverlay').classList.remove('hidden');
    }

    function closeReader(){
      el('readerFrame').src = 'about:blank';
      el('readerOverlay').classList.add('hidden');
      resetPDFViewer();
    }

    function resetPDFViewer() {
      state.pdf = { url: null, doc: null, currentPage: 1, totalPages: 1, rendering: false, bookId: null };
      const canvas = el('pdfCanvas');
      if(canvas) {
        const ctx = canvas.getContext('2d');
        if(ctx) ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      el('pdfPageInfo').textContent = '';
    }

    async function openPDFViewer(url, bookId) {
      el('pdfViewerContainer').classList.remove('hidden');
      el('readerFrame').classList.add('hidden');
      state.pdf.url = url;
      state.pdf.bookId = bookId;
      el('pdfPageInfo').textContent = 'Loading...';
      try {
        const loadingTask = window['pdfjsLib'].getDocument(url);
        state.pdf.doc = await loadingTask.promise;
        state.pdf.totalPages = state.pdf.doc.numPages;
        let pageToShow = 1;
        if(state.user && state.user.readingProgress) {
          try {
            const progress = JSON.parse(state.user.readingProgress || '{}');
            pageToShow = progress?.[bookId] || 1;
          } catch(e) {}
        }
        state.pdf.currentPage = pageToShow;
        renderPDFPage(pageToShow);
      } catch (e) {
        el('pdfPageInfo').textContent = 'Failed to load PDF';
      }
    }

    async function renderPDFPage(num) {
      if(!state.pdf.doc || state.pdf.rendering) return;
      state.pdf.rendering = true;
      const page = await state.pdf.doc.getPage(num);
      const canvas = el('pdfCanvas');
      const container = el('pdfViewerContainer');
      const scale = container.clientWidth / page.getViewport({scale: 1.0}).width;
      const viewport = page.getViewport({scale: scale});
      const ctx = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({canvasContext: ctx, viewport: viewport}).promise;
      el('pdfPageInfo').textContent = `Page ${num} / ${state.pdf.totalPages}`;
      state.pdf.rendering = false;
      saveReadingProgress(state.pdf.bookId, num);
    }

    async function saveReadingProgress(bookId, page) {
      if(!state.user || !bookId) return;
      let progress = {};
      try { progress = state.user.readingProgress ? JSON.parse(state.user.readingProgress) : {}; } catch(e) { progress = {}; }
      progress[bookId] = page;
      state.user.readingProgress = JSON.stringify(progress);
      localStorage.setItem('gs_user', JSON.stringify(state.user));
      if(saveReadingProgress.saveTimeout) clearTimeout(saveReadingProgress.saveTimeout);
      saveReadingProgress.saveTimeout = setTimeout(async () => {
        try {
          await Backendless.Data.of('Users').save({objectId: state.user.objectId, readingProgress: JSON.stringify(progress)});
        } catch (error) {
          console.error("Failed to save progress to backend:", error);
        }
      }, 1200);
    }

    function onBuyClick(e){
      const id = e.currentTarget.getAttribute('data-id');
      const book = state.books.find(b => b.objectId === id);
      state.selectedBook = book;
      el('payModalDesc').textContent = `Buy "${book.title||'this book'}" for $${Number(book.price||0).toFixed(2)}`;
      el('payModal').classList.remove('hidden');
      el('paypalButtons').innerHTML = '';
      paypal.Buttons({
        createOrder: (data, actions) => actions.order.create({
          purchase_units: [{ amount: { value: String(Number(book.price||0).toFixed(2)) }, description: `Book: ${book.title}` }]
        }),
        onApprove: async (data, actions) => {
          const details = await actions.order.capture();
          await attachPaymentAndUnlock(details, book);
          el('payModal').classList.add('hidden');
          renderBooks(state.books);
          alert('Payment successful! You now own this book.');
        },
        onError: (err) => { console.error(err); alert('An error occurred with your payment.'); }
      }).render('#paypalButtons');
    }

    async function attachPaymentAndUnlock(details, book){
      const Users = Backendless.Data.of('Users');
      const user = await Users.findById(state.user.objectId);
      let paid = [];
      try { paid = JSON.parse(user.paidbooks || '[]'); } catch { paid = []; }
      if(!paid.includes(book.objectId)) paid.push(book.objectId);
      user.paidbooks = JSON.stringify(paid);
      user.Paid = true;
      user.PaymentID = details?.id || 'N/A';
      user.paymentstatus = details?.status || 'COMPLETED';
      state.user = await Users.save(user);
      localStorage.setItem('gs_user', JSON.stringify(state.user));
    }

    function logout(){
      Backendless.UserService.logout();
      localStorage.removeItem('gs_user');
      state.user = null;
      setAuthUI(false);
      el('userEmail').textContent = 'guest';
      renderBooks(state.books);
    }

    function showAuthModal(mode){
      el('authSection').classList.remove('hidden');
      setAuthMode(mode === 'signup');
    }

    function hideAuthModal(){
      el('authSection').classList.add('hidden');
      info('');
      el('passwordInput').value = '';
      el('confirmPasswordInput').value = '';
    }

    function setAuthMode(signup){
      const isSignUp = signup;
      el('authTitle').textContent = isSignUp ? "Create Account" : "Welcome Back";
      el('authDesc').textContent = isSignUp ? "Sign up to begin your collection." : "Sign in to access your library.";
      el('authBtnText').textContent = isSignUp ? "Sign Up" : "Sign In";
      el('toggleAuthMode').textContent = isSignUp ? "Have an account? Sign In" : "New here? Create Account";
      el('confirmPasswordDiv').style.display = isSignUp ? '' : 'none';
      el('nameInput').closest('div').style.display = isSignUp ? '' : 'none';
      el('loginForm').dataset.signup = isSignUp ? "1" : "";
    }

    async function signInOrRegister(email, name, password, confirmPassword, isSignUp){
      info(isSignUp ? "Creating account‚Ä¶" : "Signing in‚Ä¶");
      const Users = Backendless.Data.of("Users");
      const deviceId = state.deviceId;

      if(isSignUp){
        if(password !== confirmPassword) throw new Error("Passwords do not match.");
        const user = new Backendless.User();
        user.email = email; user.name = name; user.password = password;
        user.deviceid = deviceId; user.paidbooks = '[]'; user.readingProgress = '{}';
        await Backendless.UserService.register(user);
        const loggedIn = await Backendless.UserService.login(email, password, true);
        state.user = loggedIn;
      } else {
        const loginUser = await Backendless.UserService.login(email, password, true);
        if(!loginUser.deviceid) {
            loginUser.deviceid = deviceId;
            await Users.save(loginUser);
        } else if(loginUser.deviceid !== deviceId) {
            await Backendless.UserService.logout();
            throw new Error("This account is linked to another device.");
        }
        state.user = loginUser;
      }
      localStorage.setItem('gs_user', JSON.stringify(state.user));
      el('userEmail').textContent = state.user.email;
      setAuthUI(true);
      await loadBooks(); // This will re-render books with correct paid status
      hideAuthModal();
      if(state.deferredAction){ state.deferredAction(); state.deferredAction = null; }
    }

    async function loadBooks(){
      const list = await Backendless.Data.of("books").find({ pageSize: 50, sortBy: ["created DESC"] });
      state.books = list;
      renderBooks(list);
    }

    async function forgotPassword(email){
      if(!email) throw new Error("Please enter your email to reset password.");
      await Backendless.UserService.restorePassword(email);
      alert("A password reset link has been sent to your email.");
    }

    document.addEventListener('DOMContentLoaded', async () => {
      el('year').textContent = new Date().getFullYear();
      state.deviceId = getDeviceId();
      await initBackendless();

      try {
        const isValid = await Backendless.UserService.isValidLogin();
        const cachedUser = localStorage.getItem('gs_user');
        if (isValid && cachedUser) {
          state.user = JSON.parse(cachedUser);
          el('userEmail').textContent = state.user.email;
          setAuthUI(true);
        } else {
          logout();
        }
      } catch (e) {
        logout();
      }

      await loadBooks();

      el('logoutBtn').addEventListener('click', logout);
      el('closeReaderBtn').addEventListener('click', closeReader);
      el('cancelPayBtn').addEventListener('click', () => el('payModal').classList.add('hidden'));
      el('closeAuthModalBtn').addEventListener('click', () => { hideAuthModal(); state.deferredAction = null; });
      
      el('pdfPrevPage').addEventListener('click', () => {
        if(state.pdf.currentPage > 1) renderPDFPage(--state.pdf.currentPage);
      });
      el('pdfNextPage').addEventListener('click', () => {
        if(state.pdf.currentPage < state.pdf.totalPages) renderPDFPage(++state.pdf.currentPage);
      });

      el('toggleAuthMode').addEventListener('click', (e) => {
        e.preventDefault();
        setAuthMode(!(el('loginForm').dataset.signup === "1"));
      });

      el('forgotPasswordLink').addEventListener('click', async (e) => {
        e.preventDefault();
        try{ await forgotPassword(el('emailInput').value.trim()); }
        catch(err){ alert(err.message); }
      });

      el('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = el('emailInput').value.trim();
        const name = el('nameInput').value.trim();
        const password = el('passwordInput').value;
        const confirmPassword = el('confirmPasswordInput').value;
        const isSignUp = el('loginForm').dataset.signup === "1";
        try{
          await signInOrRegister(email, name, password, confirmPassword, isSignUp);
        }catch(err){
          info(err.message || (isSignUp ? 'Registration failed.' : 'Login failed.'));
        }
      });
      
      hideLoader();
    });
  </script>
</body>
</html>
